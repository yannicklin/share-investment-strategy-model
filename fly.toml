# ASX Bot Trading System - Fly.io Deployment Configuration
# Updated: 2026-02-04

app = "asx-bot-trading"
primary_region = "syd"  # Sydney (closest to ASX market)

[build]
  [build.args]
    PYTHON_VERSION = "3.12"

[env]
  PORT = "8080"
  FLASK_ENV = "production"
  PYTHONUNBUFFERED = "1"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = true   # Stop after idle timeout (saves $$$)
  auto_start_machines = true  # Wake on HTTP request (cold start ~5s)
  min_machines_running = 0    # No machines running when idle (FREE!)
  max_machines_running = 1    # CRITICAL: Only 1 instance total
  processes = ["app"]

  [[http_service.checks]]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    timeout = "5s"
    path = "/health"

[processes]
  app = "gunicorn --bind :8080 --workers 1 --timeout 300 run_bot:app"

[[vm]]
  size = "shared-cpu-1x"  # 1 vCPU
  memory = "1gb"          # 1GB RAM (required for LSTM training peak 800MB)
  cpus = 1

[mounts]
  source = "bot_storage"
  destination = "/data"
  initial_size = "1gb"

# Secrets (set via: fly secrets set KEY=value)
# Required secrets:
# - DATABASE_URL (Supabase PostgreSQL connection string)
# - CRON_TOKEN (Bearer token for GitHub Actions authentication)
# - BACKUP_ENCRYPTION_KEY (32-byte base64 key for AES-256)
# - TELEGRAM_BOT_TOKEN (optional)
# - SENDGRID_API_KEY (optional)
# - TELNYX_API_KEY (optional)
# - TIGRIS_ACCESS_KEY_ID (S3 backup storage)
# - TIGRIS_SECRET_ACCESS_KEY
# - TIGRIS_ENDPOINT_URL
# - TIGRIS_BUCKET_NAME
